
本文将安装所有桌面环境通用的基础配置。建议在完成配置后创建一个快照作为存档点（我的习惯是叫 `before desktop`），方便更换或者尝试不同的桌面环境。


本文预设以 root 用户登录。

## 确认系统状态

确认当前系统是最新状态
```sh
pacman -Syu
```

`-u` 代表升级所有软件。


## 设置全局默认文本编辑器

如果不设置默认编辑器的话有些程序会默认使用 `vi` 编辑器，arch默认是没有安装 vi 的，所以不设置系统默认编辑器的话的话那些默认调用vi的软件会报错。

```sh
vim /etc/environment
```
填入使用的编辑器，以vim为例：
```sh
EDITOR=vim
```

由于是全局变量，需要`exit`注销后重新登录才能生效。


## 创建用户

有些软件会拒绝在root权限下运行，所以非root用户是必须的。

### 创建管理员用户

1. 新建用户

    ```sh
    useradd -mG wheel <用户名>
    ```

    `-m`表示同时创建用户home目录，`-G wheel`表示将用户加入wheel管理员权限组。


2. 设置密码

    ```sh
    passwd <用户名>
    ```

3. 设置管理员权限

    ```sh
    visudo
    #等价于 vim /etc/sudoers
    ```

    搜索 `wheel`，取消这一行的注释：
    ```
    %wheel ALL=（ALL：ALL） ALL
    ```
    保存退出


### 创建普通用户

步骤更简单

1. 创建用户

    ```sh
    useradd -m <用户名>
    ```
    `-m`表示同时创建用户home目录

2. 设置密码
    ```sh
    passwd <用户名>
    ```


## 开启32位软件源

32位源建议开启，桌面用户必需。steam需要，wine运行exe也需要。

如果是用archinstall脚本安装系统应该已经开启了。

1. 编辑 pacman 配置文件：

    ```sh
    vim /etc/pacman.conf
    ```

    左斜杠`/`搜索 `multilib`，取消以下两行注释
    ```
    [multilib]
    include = /etc/pacman.d/mirrorlist
    ```

2. 可选配置：
    - 把`ParallelDownloads`的数值调大，这是多线程下载，默认是5
    - 添加 `archlinuxcn` 源，见下文。

3. 保存退出。同步数据库

    ```sh
    pacman -Sy
    ```

## 添加archlinuxcn源

[archlinuxcn](https://www.archlinuxcn.org/archlinux-cn-repo-and-mirror/)源包含了很多好用的软件。


1. 编辑pacman配置文件

    ```sh
    vim /etc/pacman.conf
    ```

    按 G 到文件底部，写入任意一个或多个源：

    - 中科大源：
        ```
        [archlinuxcn]
        Server = https://mirrors.ustc.edu.cn/archlinuxcn/$arch
        ```

    - 腾讯云源：
        ```
        [archlinuxcn]
        Server = https://mirrors.cloud.tencent.com/archlinuxcn/$arch
        ```

    - 哈工大源：
        ```sh
        [archlinuxcn] 
        Server = https://mirrors.hit.edu.cn/archlinuxcn/$arch 
        ```

    更多源可以在[这里](https://github.com/archlinuxcn/mirrorlist-repo)找到。


2. 同步数据库并安装`archlinuxcn`密钥

    ```sh
    pacman -Sy archlinuxcn-keyring 
    ```


## 安装AUR助手

配置好archlinuxcn源之后，可以从上面下载AUR助手，用于从 [AUR](https://wiki.archlinux.org/title/Arch_User_Repository) 用户软件仓库下载软件。

> **注意**：AUR很方便，但要注意辨识它是否安全。


```sh
pacman -S --needed yay paru
```

`yay`和`paru`都常用，任选其一即可，也可以两个都装。


## 字体

基础字体一般用noto-fonts，中文看个人喜好，wqy-zenhei不怎么占空间，可以作为最基础的中文字体使用。后续再装自己喜欢的字体。

- 谷歌开源字体
    ```sh
    pacman -S --needed noto-fonts noto-fonts-emoji
    ```

    - `noto-fonts`是谷歌字体，包含多个国家的语言

    - `noto-fonts-emoji`是emoji

    - 还有两个noto字体：`noto-fonts-cjk`和`noto-fonts-extra`可装可不装

- 中文字体，看自己喜好

    文泉驿正黑
    ```sh
    pacman -S --needed wqy-zenhei
    ```
    思源黑体
    ```sh
    pacman -S --needed adobe-source-han-sans-cn-fonts
    ```


## 音视频固件和服务

让音频设备和屏幕分享正常工作。

1. 可选：安装音视频固件

    ```sh
    pacman -S --needed sof-firmware alsa-ucm-conf alsa-firmware 
    ```

    - `sof-firmware`为现代音视频设备提供固件，通常装这个就可以了

    - `alsa-ucm-conf`提供必要的配置文件

    - `alsa-firmware`为不常见或者较旧的设备提供固件


2. 安装音视频服务

    ```sh
    pacman -S --needed pipewire wireplumber pipewire-pulse pipewire-alsa pipewire-jack 
    ```

    - `pipewire`是由redhat主导开发的现代音视频服务

    - `wireplumber`会智能管理pipewire

    - `pipewire-pulse` `pipewire-alsa` `pipewire-jack`分别为pulseAudio、ALSA、JACK提供兼容


3. 启用服务

    ```sh
    systemctl --user enable --now pipewire pipewire-pulse wireplumber
    ```


## 蓝牙

1. 安装

    ```sh
    pacman -S --needed bluez
    ```

2. 启动服务

    ```sh
    systemctl enable --now bluetooth
    ```


## 性能模式切换

`power-profiles-daemon`是各个桌面环境通用的性能模式切换服务，有三个档位，performance性能、balance平衡、powersave节电。一般平衡档位就够用了，也不需要调节风扇什么的。


1. 安装

    ```sh
    pacman -S power-profiles-daemon
    ```

2. 启动服务

    ```sh
    systemctl enable --now power-profiles-daemon 
    ```

这个易用而且足够，不建议使用tlp或者auto-cpufreq，功耗上不会有明显区别。



## flatpak软件管理


flatpak是全发行版通用的打包方式，依赖和插件比较多的软件flatpak版本通常更好用，比如obs和easyeffects，如果aur和仓库的软件都不太正常，也可以尝试flatpak版本。

1. 安装`flatpak`

    ```sh
    pacman -S --needed flatpak
    ```

2. 设置软件源

    如果之前从未使用过 Flathub，那么首先需要添加 Flathub 远程源：

    ```sh
    flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo
    ```

3. 可选：更换国内源

    在已有 flathub 远程源的基础上：

    - 上交大

        ```sh
        flatpak remote-modify flathub --url=https://mirror.sjtu.edu.cn/flathub
        ```

    - 中科大

        ```sh
        flatpak remote-modify flathub --url=https://mirrors.ustc.edu.cn/flathub
        ```

    **注意**：即使用了国内镜像站 你也需要让你的网络能访问flathub官方仓库 你才能下载所有的包


4. 可选：如果要恢复默认源

    ```sh
    flatpak remote-modify flathub --url=https://dl.flathub.org/repo
    ```


## 可选：休眠到硬盘


**前提**：如果需要休眠到硬盘功能，且之前设置了硬盘swap的话。


1. 先查看 `/etc/mkinitcpio.conf` 的 `HOOKS` 部分:
    - 如果是 `HOOKS(base systemd ...)` -> 无须手动配置，跳过后续步骤
    - 如果是 `HOOKS(base udev ...)` -> 进行后续配置

2. 如果是 `HOOKS(base udev ...)`
    1. 添加 hook：
        ```sh
        vim /etc/mkinitcpio.conf
        ```
        在`HOOKS()`内添加`resume`,注意需要添加在`udev`的后面
        
    2. 重新生成initramfs
        ```sh
        mkinitcpio -P
        ```

    3. 重启电脑
        ```sh
        reboot
        ```

    4. 使用命令进行休眠

        ```sh
        systemctl hibernate
        ```


## 重启电脑生效

```sh
reboot
```


## 下一节：[快照和系统维护](./快照和系统维护)



