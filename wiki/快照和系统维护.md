
现在我们已经完成了安装桌面环境前的所有准备工作，为了方便尝试不同的桌面，可以创建一个快照当作存档点，想玩别的随时回档。另外，**养成习惯，每次做自己不了解的事情之前都存个档**，如果出了问题或者后悔了可以恢复到快照时的状态。

- **前提**：由于默认grub路径是`/boot`，而我们之前的grub安装在`/efi`，所以需要一个软链接。如果你安装的时候已经创建了的话跳过这一步。

    ```sh
    sudo ln -sf /efi/grub /boot/grub
    ```


## snapper

opensuse开发的快照软件，超级好用。

1. 安装 snapper 和必要组件

    ```sh
    sudo pacman -S --needed snapper btrfs-assistant grub-btrfs inotify-tools
    ```

    `snapper` 是主程序

    `btrfs-assistant` 是GUI（图形化交互界面），同时提供了几个简单的命令，进一步简化快照回档需要的操作。我们还没有安装桌面环境，但是肯定会用到，先装上。

    `grub-btrfs` 和 `inotify-tools` 用于在创建快照的时候自动在grub菜单里添加快照启动项


2. 可选：安装 `snap-pac`

    `snap-pac` 的作用是利用钩子在进行pacman命令的时候自动创建快照，有需要的可以装一下

    ```sh
    sudo pacman -S --needed snap-pac
    ```

    > 我更喜欢手动创建快照，因此一般不装


3. 重启电脑用新的initramfs进入系统

    ```sh
    reboot
    ```

4. 激活快照启动项服务

    ```sh
    sudo systemctl enable --now grub-btrfsd
    ```

5. 创建快照配置

    为 `/` 和 `/home` 分别创建配置：

    - root快照
        ```sh
        snapper -c root create-config /
        ```
        `-c root`指定要使用的配置名称，由于该配置不存在，所以`create-config`创建，快照范围是`/`。

    - home快照
        ```sh
        snapper -c home create-config /home
        ```

6. 创建快照

    分别创建home和root的快照：

    ```sh
    snapper -c root create --description "before desktop"
    snapper -c home create --description "before desktop"
    ```

    `create`创建快照，`--description`添加自定义描述。我们这里是安装桌面之前，所以描述为 "before desktop"。

7. 生成grub菜单入口

    为了方便快照回档，我们接着来配置从grub菜单进入快照的功能。要至少运行一次`grub-mkconfig`生成grub菜单的snapshot入口

    ```sh
    sudo grub-mkconfig -o /boot/grub/grub.cfg
    ```


现在就配置好快照啦。


## 回档方法

### 方法一：snapper命令行

1. 列出可用快照

    ```sh
    snapper -c root list
    ```

    找到自己想使用的快照的数字序号

2. `undochange`回档

    ```sh
    snapper -c root undochange 1..0
    ```

    这里的`1..0`，`1`是你要使用的快照的序号，`0`代表当前状态。

    这条命令会对比两者的区别，对当前状态进行修改，无须重启，重新登录即可生效。

    ⚠️注意：官方文档不建议用`undochange`回档root。

home配置以此类推。


### 方法二：btrfs-assistant命令行

**记得用root登录**

1. 切换至root用户

    ```sh
    su -
    ```

2. 列出可用快照

    ```sh
    btrfs-assistant -l
    ```

    找到目标快照的数字序号。

3. 回档

    ```sh
    btrfs-assistant -r 1
    ```

    这里的数字1是要使用的快照的数字序号。


### 方法三：btrfs-assistant图形界面

此时还没有安装桌面环境，你可以后续回来看。

1. 创建配置（如果没有）

    打开`btrfs assistant`，切换到`snapper settings`页面。我们创建子卷的时候至少创建了一个`@`子卷和一个`@home`子卷，所以需要两个config（配置）。

    - root 根目录快照

        点击`new config`新建配置，`config name`写root，`backup path`选择 / ，然后点击save保存。

        接着进行一些按照时间自动生成快照的设置：
        - `systemd unit settings`里面有三个服务。 
        - `timeline`是按照时间计划自动创建快照；
        - `cleanup`是快照数量达到number设定的数量上限之后自动清理快照；
        - `boot`是每次开机自动创建快照。
        
        按需设置，设置完记得点apply。

    - home目录快照

        按照同样的方法创建一个home目录的配置。

2. 创建快照

    到`snapper`页面，`select config`选择配置，要创建root子卷的快照就选择刚刚创建的名为root的配置。点击`new`创建快照，`description`是快照的自定义文字描述（注释）。

3. 使用快照进行恢复

    `snapper`页面 --> `Browse/restore`页面

    `select target`选择想恢复的子卷，再选择想使用的快照，点击`restore`，此时会自动帮你创建一个额外的子卷用来备份当前的数据然后弹出一个确认窗口让你填写这个子卷的名字（可以空着不填写）


4. 使用快照进行全盘恢复

    因为root子卷和home子卷在创建的时候是平级的，所以虽然root目录包含了home目录，但是创建root子卷的快照时不会包含home子卷里的内容。这样的子卷布局叫作“扁平布局”。

    因此，需要分别创建root和home的快照，然后分别恢复root子卷和home子卷。


### 方法四：从grub菜单快照启动项进入系统

**无法正常进入系统时使用该方法**。用btrfs-assistant回档，GUI或者命令行都可以。记得用root身份登录。

#### 如果无法从快照启动项进入系统

1. 设置覆盖文件系统（overlayfs）

    设置一个overlayfs在内存中创建一个临时可写的类似live-cd的环境，否则可能无法正常从快照启动项进入系统。

2. 编辑`/etc/mkinitcpio.conf`

    ```sh
    sudo vim /etc/mkinitcpio.conf
    ```

3. 在HOOKS里添加`grub-btrfs-overlayfs`

    ```sh
    HOOKS= ( ...... grub-btrfs-overlayfs )
    ```

4. 重新生成initramfs

    ```sh
    sudo mkinitcpio -P
    ```

5. 重启电脑


## 拓展内容：downgrade


有时候软件更新完之后可能反而不好用，这时就要使用downgrade退回之前的版本。

```sh
yay -S downgrade
```

使用方法：
```sh
sudo downgrade 要回退的软件包
```

比如如果我要回退ghostty的话就是：
```sh
sudo downgrade ghostty
```


## 拓展内容：手动快照回档

你可以跳过这部分内容。

1. 确认根分区设备名

    ```sh
    findmnt /
    ```

    输出类似于：
    ```sh
    TARGET SOURCE          FSTYPE OPTIONS
    /      /dev/nvme0n1p2[/@]
                        btrfs  rw,relatime,compress=zstd:3,ssd,discard=async,space_cache=v2,subvolid=256,
    ```

    其中`/dev/nvme0n1p2`是我的根分区


2. 挂载顶级卷

    我们运行的系统是在`@`子卷里面的。想对`@`进行操作，首先要挂载`/`

    ```sh
    sudo mount --mkdir -t btrfs -o subvolid=5 /dev/nvme0n1p2 /mnt/btrfs
    ```

    `subvolid=5`指定顶级卷；`/dev/nvme0n1p2`更换为你实际的根分区设备名；挂载到了`/mnt/btrfs`目录。

    > 如果是快照启动项进入的系统，可能无法读写`/mnt`，此时可以挂载到`/tmp/btrfs`。


3. 进入目录

    ```sh
    cd /mnt/btrfs
    ```

    此时 `ls` 可以看到我们的 `@` 和 `@home` 子卷

4. 备份`@`子卷

    ```sh
    mv @ @_bak1
    ```

    这条命令把`@`重命名为`@_bak1`

5. 快照回档

    我们的快照文件通常存放在`@/.snapshots`目录下，`@`被移动到了`@_bak1`，所以现在快照文件就在`@_bak1/.snapshots`里面。

    ```sh
    btrfs subvolume snapshot @_bak1/.snapshots/1/snapshot @
    ```

    这条命令把`@_bak1/.snapshots`目录下序号为1的快照恢复到了`/mnt/btrfs/@`


6. 移动快照文件

    需要把`@_bak1`里的快照文件移到新的`@`里

    先删除新的`@`里的`.snapshots`
    ```sh
    rmdir @/.snapshots
    ```

    然后移动`@_bak1`里的`.snapshots`
    ```sh
    mv @_bak1/.snapshots @/.snapshots
    ```

7. 删除`@_bak1`

    如果想删除备份快照，需要先把里面的子卷删除。

    ```sh
    btrfs subvolume list -o @_bak1
    ```

    删掉所有`@_bak1`开头的子卷，然后才能删掉`@_bak1`

    ```sh
    btrfs subvolume delete @_bak1/var/lib/portables
    btrfs subvolume delete @_bak1/var/lib/machines
    ```

    ```sh
    btrfs subvolume delete @_bak1
    ```

8. 重启

    ```sh
    reboot
    ```

## 关于滚挂和良好的系统使用习惯

- 滚挂

    archlinux是滚动发行版。滚动是英文直译，原词是rolling，指一种推送更新的方式，只要有新版本就会推送，由用户管理更新。对应的另一种更新方式是定期更新一个大版本，例如fedora是六个月一更新，由发行方管理更新。 滚挂，指的是滚动更新的发行版因为更新导致系统异常。这通常是用户操作不当、忽略官方公告等原因导致的。只要学习一下正确的更新方式和快照的使用方法就不用担心滚挂问题。

    通常软件更新不用担心。出现密钥（keyring）、内核、驱动、固件、引导程序之类的更新要留个心眼，先不第一时间更新，等一手社区消息。 另一个重点是滚动更新的发行版的软件通常会适配最新的依赖，如果部分更新可能会无法使用软件。

- 良好的使用习惯

    btrfs文件系统已经足够稳定，“不作死就不会死”。使用时遵循以下几点：

    1. 别第一时间更新，别长时间不更新，别部分更新，密钥单独更新，重要程序更新前创建快照
    
    2. 弄坏系统的通常是用户自己的不当操作，明白自己的行为会造成怎样的后果，做不了解的事情前创建快照

