
在安装完系统重启电脑之前，还需要完成一些必要步骤。


## 进入系统(chroot)

请确保此时处于刚刚安装的系统中，注意此时的命令提示符是否不同于live环境。

如果不是，用 `chroot` 进入刚刚安装的系统：
```sh
chroot /mnt
```


## 本地化设置

1. 编辑 `locale.gen` 配置文件
    
    ```sh
    vim /etc/locale.gen
    ```

    取消`en_US.UTF-8 UTF-8`和`zh_CN.UTF-8`的注释

    > **vim操作要点**：方向键移动光标；`i`键进入编辑模式；`esc`退出编辑模式；`/`左斜杠键进行搜索(`n`跳转下一个结果，`shift-n`跳转上一个结果)；`:wq`保存并退出。


2. 生成本地化配置

    ```sh
    locale-gen
    ```

3. 设置系统语言

    ```sh
    vim /etc/locale.conf
    ```

    设置为英文（一般默认就是）：
    ```
    LANG=en_US.UTF-8
    ```

    `/etc/locale.conf` 这个文件是系统级的语言设置，在这里设置为中文可能导致软件显示出错，所以不建议这么做。我的习惯是**设置系统语言为英文，单独为各个应用设置中文**。

    后续安装完桌面环境后通过桌面环境提供的选项在用户空间修改系统语言即可。例如通过`AccountService`的偏好储存功能，你上次登录的会话、系统语言等内容都会存在`/var/lib/AccountService/users/你的用户名`这个文件里面。没有显示管理器的话可以在`~/.config/locale.conf`写入中文设置，覆盖掉`/etc/locale.conf`的设置。



## 配置双系统

如果不需要配置双系统可以跳过这一步。

1. 安装需要的组件：
    ```sh
    pacman -S --needed os-prober exfat-utils
    ```
    这两个组件用来计算机中的windows系统。

2. 编辑grub配置文件
    
    ```sh
    vim /etc/default/grub
    ```

    取消最后一行`GRUB_DISABLE_OS_PROBER=false`的注释




## 配置GRUB引导程序

1. 编辑grub配置文件：
    ```sh
    vim /etc/default/grub
    ```
    
    设置：

    - 启动项记忆功能
        
        `GRUB_DEFAULT=0`改成`=saved`，再取消`GRUB_SAVEDEFAULT=true`的注释。

    - 显示开机日志

        `GRUB_CMDLINE_LINUX_DEFAULT`里面去掉`quiet`以显示开机日志。有些发行版还会出现`slash`之类的字样，代表的是开机动画。再设置`loglevel=5`把日志等级为5。`loglevel`共7级，5级是一个信息量的平衡点。

    - 禁用watchdog

        `GRUB_CMDLINE_LINUX_DEFAULT` 里添加 `nowatchdog` 以及 `modprobe.blacklist=iTCO_wdt`。AMD cpu用户把 `iTCO_wdt` 换成 `sp5100_tco`。

        > watchdog的目的简单来说是在系统死机的时候自动重启系统。对个人用户来说没有意义，禁用以节省系统资源、提高开机和关机速度。


2. 生成grub的配置文件

    ```sh
    grub-mkconfig -o /efi/grub/grub.cfg
    ```


3. 在grub的默认安装位置创建链接

    ```sh
    ln -sf /efi/grub /boot/grub
    ```

    我们的grub在`/efi/grub`，大多数程序会默认检测`/boot/grub`作为grub的安装位置，所以创建一个链接方便使用。


## 配置zram

zram将内存的一部分空间用作交换空间，如果你没有配置swap，请一定配置zram。如果配置了swap的话可以不配置zram。

1. 安装`zram-generator`
    ```sh
    sudo pacman -S zram-generator
    ```

2. 编辑配置文件：

    ```sh
    sudo vim  /etc/systemd/zram-generator.conf
    ```
    ```
    [zram0]
    zram-size = ram
    compression-algorithm = zstd 
    ```

    `zram-size`设置最多存储多少数据，注意这里设置的是压缩之前的大小。

    `compression-algorithm`这一行设置使用`zstd`算法。


3. 禁用zswap

    zswap是swap的缓存。需要交换的数据在存入交换空间之前会先被zswap压缩后暂时放进内存里。和zram功能重复且引入了复杂性，故禁用。

    ```sh
    sudo vim /etc/default/grub
    ```

    在`GRUB_CMDLINE_LINUX_DEFAULT=""`里写入`zswap.enabled=0`

    ```
    GRUB_CMDLINE_LINUX_DEFAULT="... zswap.enabled=0 ... "
    ```

4. 重新生成grub的配置文件
    
    ```sh
    sudo grub-mkconfig -o /efi/grub/grub.cfg
    ```

## 退出chroot

```sh
exit
```

此时就回到了live环境，可以注意到提示符的变化。


## 重启电脑

```sh
reboot
```

## 拔掉系统u盘

如果u盘没拔掉的话记得拔掉


## 选择BIOS启动项

通常默认就是刚刚安装的arch，如果不是的话选择一下启动项。

如果没有出现archlinux的启动项，看archwiki的[这个页面](https://wiki.archlinux.org/title/GRUB)。


## 登录账户

进入系统后，输入账户密码。


## 连接网络

如果没有安装桌面环境，可以按照以下步骤联网。

1. 开启`networkmanager`服务，注意大小写
    ```sh
    systemctl enable --now NetworkManager 
    ```

    `systemctl`调用systemd进行操作

    `enbale`代表开机自启 `--now` 代表现在启动

2. 连接wifi

    ```sh
    nmtui
    ```

    nmtui是networkmanager提供的TUI（终端用户交互程序）

    选择activate a connection > 选择自己的wifi进行连接 > esc退出 > Ctrl+L或者`clear`清屏

3. 验证是否有网

    ```sh
    ip a
    ping -c 3 bilibili.com
    ```

